this is globalmem code from book
